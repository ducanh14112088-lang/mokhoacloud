<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Order Seri + Thanh toán MB Bank</title>
<style>
body{font-family:Arial;margin:0;padding:0;background:#f5f5f5}
header{background:#222;color:#fff;padding:16px;text-align:center;font-size:22px}
.container{max-width:900px;margin:20px auto;padding:10px}
.product{background:#fff;padding:16px;border-radius:10px;margin-bottom:12px;border:1px solid #ddd}
.product h3{margin:0 0 8px 0}
button{padding:8px 14px;font-size:16px;border-radius:6px;cursor:pointer;border:none;color:#fff}
button.green{background:#28a745}
button.blue{background:#17a2b8}
button.red{background:#dc3545}
button.gray{background:#555}
input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;margin-top:6px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999}
.modal-box{background:#fff;padding:20px;border-radius:10px;width:95%;max-width:450px}
#orderHistory table{width:100%;border-collapse:collapse}
#orderHistory th,#orderHistory td{border:1px solid #ccc;padding:6px}
</style>
</head>
<body>

<header>
  Order Seri – Thanh toán MB Bank
  <div id="userStatus" style="margin-top:8px;font-size:14px;"></div>
</header>

<div class="container" id="products"></div>

<div class="container" id="orderHistory" style="display:none">
  <h3>Lịch sử mua hàng</h3>
  <table>
    <thead><tr><th>ID</th><th>Sản phẩm</th><th>Giá</th><th>SERI</th><th>Ngày</th></tr></thead>
    <tbody id="orderTableBody"></tbody>
  </table>
</div>

<!-- Trang nạp tiền MB -->
<div class="container" id="topUpPage" style="display:none">
  <h3>Nạp tiền qua MB Bank</h3>
  <p><b>STK:</b> 1404123456</p>
  <p><b>Chủ tài khoản:</b> NGUYEN DUC ANH</p>
  <p><b>Nội dung chuyển khoản:</b> Email đăng ký của bạn</p>
  <p><i>Tiền sẽ được cộng tự động sau 1–5 phút.</i></p>
  <button class="gray" onclick="closeTopUpPage()">Quay lại</button>
</div>

<!-- Modal nhập seri -->
<div class="modal" id="seriModal">
  <div class="modal-box">
    <h2>Nhập SERI</h2>
    <div><b>Sản phẩm:</b> <span id="seriProd"></span></div>
    <div><b>Giá:</b> <span id="seriPrice"></span></div>
    <textarea id="inputSeri" rows="3" placeholder="Nhập seri..."></textarea>
    <button class="green" onclick="confirmBuy()">Xác nhận</button>
    <button class="gray" onclick="closeSeriModal()">Hủy</button>
  </div>
</div>

<script>
// Sản phẩm
const PRODUCTS = [
  {id:1,name:"Nothing PRO Bypass iPhone 11 - 17 Pro Max",price:120000},
  {id:2,name:"HFZ Activator A12+ Premium",price:120000},
  {id:3,name:"iRemove Tool A12",price:160000},
  {id:4,name:"Mina A12 Bypass No Signal",price:210000},
  {id:5,name:"FRPFILE ACTIVATOR A12+",price:90000}
];

// Load danh sách sản phẩm
const pBox = document.getElementById("products");
PRODUCTS.forEach(p=>{
  pBox.innerHTML += `
    <div class="product">
      <h3>${p.name}</h3>
      <div>Giá: <b>${p.price.toLocaleString()} VND</b></div>
      <button class="green" onclick="buyNow(${p.id})">Mua ngay</button>
    </div>`;
});

// User dữ liệu local
function getUser(){
  const email = localStorage.getItem("currentUser");
  if(!email) return null;
  let users = JSON.parse(localStorage.getItem("users")||"[]");
  return users.find(u=>u.email===email) || null;
}

function saveUser(u){
  let users = JSON.parse(localStorage.getItem("users")||"[]");
  let i = users.findIndex(x=>x.email===u.email);
  users[i]=u;
  localStorage.setItem("users",JSON.stringify(users));
}

// Mua hàng
let currentProduct=null;

function buyNow(id){
  const user = getUser();
  if(!user){
    alert("Bạn chưa đăng nhập!");
    return;
  }
  currentProduct = PRODUCTS.find(p=>p.id===id);
  if(user.balance < currentProduct.price){
    alert("Không đủ số dư! Vui lòng nạp tiền.");
    openTopUpPage();
    return;
  }
  document.getElementById("seriProd").textContent = currentProduct.name;
  document.getElementById("seriPrice").textContent = currentProduct.price.toLocaleString()+" VND";
  document.getElementById("inputSeri").value="";
  document.getElementById("seriModal").style.display="flex";
}

function closeSeriModal(){
  document.getElementById("seriModal").style.display="none";
}

function confirmBuy(){
  const seri = document.getElementById("inputSeri").value.trim();
  if(!seri){ alert("Nhập SERI!"); return; }

  let user = getUser();
  user.balance -= currentProduct.price;

  user.orders.push({
    id:"ORD"+Date.now(),
    product:currentProduct.name,
    price:currentProduct.price,
    seri:seri,
    date:new Date().toLocaleString()
  });

  saveUser(user);
  closeSeriModal();
  loadUserUI();
  loadHistory();

  alert("Mua thành công!");
}

// Trang nạp tiền MB
function openTopUpPage(){
  document.getElementById("products").style.display="none";
  document.getElementById("orderHistory").style.display="none";
  document.getElementById("topUpPage").style.display="block";
}
function closeTopUpPage(){
  document.getElementById("topUpPage").style.display="none";
  document.getElementById("products").style.display="block";
  loadHistory();
}

// Hiển thị user
function loadUserUI(){
  const user = getUser();
  if(user){
    document.getElementById("userStatus").innerHTML =
      `Đăng nhập: <b>${user.email}</b> | Số dư: <b>${user.balance.toLocaleString()} VND</b>
       <button class="blue" onclick="openTopUpPage()">Nạp tiền</button>
       <button class="red" onclick="logout()">Đăng xuất</button>`;
  } else {
    document.getElementById("userStatus").innerHTML =
      `<button class="green" onclick="signup()">Đăng ký</button>
       <button class="blue" onclick="login()">Đăng nhập</button>`;
  }
}

// Lịch sử
function loadHistory(){
  const user = getUser();
  const box = document.getElementById("orderHistory");
  const tbody = document.getElementById("orderTableBody");

  if(!user || !user.orders.length){ box.style.display="none"; return; }

  tbody.innerHTML="";
  user.orders.forEach(o=>{
    tbody.innerHTML += `<tr>
      <td>${o.id}</td>
      <td>${o.product}</td>
      <td>${o.price.toLocaleString()}</td>
      <td>${o.seri}</td>
      <td>${o.date}</td>
    </tr>`;
  });
  box.style.display="block";
}

// Đăng ký
function signup(){
  const email = prompt("Nhập email:");
  const pass  = prompt("Mật khẩu:");
  if(!email || !pass) return;

  let users = JSON.parse(localStorage.getItem("users")||"[]");
  if(users.find(u=>u.email===email)){
    alert("Email đã tồn tại!");
    return;
  }

  users.push({email,pass,balance:0,orders:[]});
  localStorage.setItem("users",JSON.stringify(users));
  alert("Đăng ký thành công!");
}

// Đăng nhập
function login(){
  const email = prompt("Email:");
  const pass  = prompt("Mật khẩu:");

  let users = JSON.parse(localStorage.getItem("users")||"[]");
  let u = users.find(x=>x.email===email && x.pass===pass);
  if(!u){ alert("Sai thông tin!"); return; }

  localStorage.setItem("currentUser",email);
  loadUserUI();
  loadHistory();
}

// Đăng xuất
function logout(){
  localStorage.removeItem("currentUser");
  loadUserUI();
  document.getElementById("orderHistory").style.display="none";
}

window.onload = ()=>{
  loadUserUI();
  loadHistory();
}
</script>

</body>
</html>
