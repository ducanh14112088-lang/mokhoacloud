<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>iBYPASS SHOP - Cửa hàng</title>
  <meta name="theme-color" content="#00ff9d">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>Unlock</text></svg>">
  <style>
    :root{--pri:#00ff9d;--bg:#0a0a0f;--card:#111118;--warn:#ff6b6b}
    body{margin:0;font-family:Segoe UI,sans-serif;background:var(--bg);color:#e0e7ff;min-height:100vh;position:relative}
    header{position:sticky;top:0;z-index:99;background:rgba(10,10,15,0.95);backdrop-filter:blur(12px);border-bottom:1px solid #333;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:30px;font-weight:900;background:linear-gradient(90deg,#00ff9d,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .online-badge{background:#00ff9d;color:#000;padding:4px 12px;border-radius:20px;font-size:12px;animation:blink 2s infinite;font-weight:900}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(0,255,157,0.2);border-radius:18px;padding:28px;margin-bottom:24px;box-shadow:0 10px 40px #0006}
    #products{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-top:20px}
    .product{background:rgba(0,255,157,0.05);border:1px solid rgba(0,255,157,0.3);border-radius:16px;padding:24px;text-align:center;transition:.3s}
    .product:hover{transform:translateY(-8px);box-shadow:0 15px 30px rgba(0,255,157,0.2)}
    .price{font-size:32px;font-weight:900;color:#00ff9d}
    .btn{background:linear-gradient(90deg,#00ff9d,#00d4ff);color:#000;padding:14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn-buy{width:100%;padding:16px;font-size:18px}
    .warning{background:#300;border:2px solid var(--warn);padding:20px;border-radius:16px}
    .order-code{font-size:20px;color:#00ff9d;background:#000;padding:6px 14px;border-radius:10px;font-weight:900;cursor:pointer}
    #loader{position:fixed;inset:0;background:#0a0a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#00ff9d;font-size:24px}
    .spinner{width:60px;height:60px;border:6px solid #333;border-top:6px solid #00ff9d;border-radius:50%;animation:s 1s linear infinite;margin-top:20px}
    @keyframes s{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .backtop{position:fixed;bottom:20px;right:20px;background:#00ff9d;color:#000;padding:15px 18px;border:none;border-radius:50%;font-size:24px;box-shadow:0 4px 20px #00ff9d88;z-index:99;cursor:pointer}
    .telegram-btn{position:fixed;bottom:20px;left:20px;background:#0088cc;color:white;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:0 4px 20px #0088cc88;z-index:999}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{max-width:500px;width:90%;background:#111;padding:30px;border-radius:18px;border:2px solid var(--pri)}
  </style>
</head>
<body>

<div id="loader"><div>Đang tải iBYPASS SHOP...</div><div class="spinner"></div></div>

<header>
  <div><span class="logo">iBYPASS</span> SHOP <span class="online-badge">ONLINE</span></div>
  <nav>
    <a href="index.html">Trang chủ</a>
    <a href="dashboard.html">Cửa hàng</a>
    <a href="admin.html" id="adminLink" style="display:none;color:#ff0066;font-weight:700">ADMIN PANEL</a>
    <span id="status">Chưa đăng nhập</span>
    <button class="btn" id="authBtn">Đăng nhập</button>
  </nav>
</header>

<div class="container">
  <div class="card" style="text-align:center">
    <h1 style="color:#00ff9d;font-size:36px;margin:0">Số dư: <span id="balance">0</span> VND</h1>
  </div>

  <div class="card warning">
    <h2 style="color:var(--warn)">LƯU Ý CHUNG</h2>
    <ul style="color:#ffaa00;line-height:2">
      <li>Tất cả dịch vụ KHÔNG CÓ SÓNG – chỉ dùng WiFi</li>
      <li>Không hủy đơn, hoàn tiền nếu lỗi source > 48h</li>
      <li>Tháo SIM + WiFi mạnh trước khi bypass</li>
    </ul>
  </div>

  <div id="products"></div>

  <div class="card">
    <h2>Nạp tiền tự động 24/7</h2>
    <p>STK: <strong>1404123456</strong> – MB Bank – <strong>NGUYEN DUC ANH</strong></p>
    <p>Nội dung: <code style="color:#00ff9d" id="emailShow">Đăng nhập để xem</code></p>
    <input id="topupAmount" type="number" placeholder="Số tiền (VD: 100000)" style="padding:14px;margin:10px 0;width:100%;border-radius:12px;background:#000;color:#fff;border:1px solid #333">
    <button class="btn" id="topupBtn" disabled>Tôi đã chuyển</button>
  </div>

  <div class="card" id="history" style="display:none">
    <h2>Lịch sử đơn hàng</h2>
    <table width="100%"><thead><tr><th>Mã đơn</th><th>Sản phẩm</th><th>Giá</th><th>Seri</th><th>Trạng thái</th><th>Thời gian</th></tr></thead><tbody id="tbody"></tbody></table>
  </div>
</div>

<button class="backtop" onclick="scrollTo(0,0)">Up</button>
<a href="https://t.me/dung_tool_wallet" target="_blank" class="telegram-btn">Telegram</a>
<div id="modalRoot" class="modal-backdrop"><div class="modal" id="modalInner"></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, set, get, push, remove, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAidLdO5tVK8CkwRdMY91hG-ulXiNEohl4",
    authDomain: "mokhoacloud.firebaseapp.com",
    databaseURL: "https://mokhoacloud-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mokhoacloud",
    storageBucket: "mokhoacloud.firebasestorage.app",
    messagingSenderId: "1013749304224",
    appId: "1:1013749304224:web:2a02b904c17c0aaf7c32c5"
 20};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  if(!localStorage.getItem('userEmail')) location.href='index.html';
  document.getElementById('loader').remove();

  const ding = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3');
  const $ = s => document.querySelector(s);

  let currentUser = null;

  async function loadUser(){
    const email = localStorage.getItem('userEmail');
    if(!email) return;
    const userRef = ref(db,'users/'+btoa(email));
    onValue(userRef,snap=>{
      if(snap.exists()){
        currentUser = {...snap.val(),email};
        renderAll();
      }
    });
  }

  function copyCode(code){navigator.clipboard.writeText(code);alert('Đã copy mã đơn: '+code);}

  function renderAll(){
    const u = currentUser;
    $('#status').textContent = u ? u.email + (u.email==='998822jj'?' (Admin)': '') : 'Chưa đăng nhập';
    $('#status').style.color = u?.email==='998822jj' ? '#ff0066' : '#00ff9d';
    $('#authBtn').textContent = 'Đăng xuất';
    $('#adminLink').style.display = u?.email==='998822jj' ? 'inline' : 'none';
    $('#emailShow').textContent = u.email;
    $('#topupBtn').disabled = false;
    $('#balance').textContent = (u.balance||0).toLocaleString();

    // Load sản phẩm từ Firebase
    onValue(ref(db,'products'),snap=>{
      const prods = snap.val() || {};
      $('#products').innerHTML = Object.values(prods).map(p=>`
        <div class="product">
          <h3>${p.name}</h3><p>${p.desc}</p>
          <div class="price">${p.price.toLocaleString()}₫</div>
          <button class="btn btn-buy" onclick="buy('${p.name}',${p.price})">MUA NGAY</button>
        </div>
      `).join('');
    },{onlyOnce:false});

    // Lịch sử đơn
    if(u.orders && Object.keys(u.orders).length){
      $('#history').style.display = 'block';
      $('#tbody').innerHTML = '';
      Object.values(u.orders).reverse().forEach(o=>{
        const status = o.status==='success'?'DONE':(o.status==='refunded'?'HOÀN':'PENDING');
        const color = o.status==='success'?'#00ff9d':(o.status==='refunded'?'#ff6b6b':'#ffaa00');
        $('#tbody').innerHTML += `<tr>
          <td><code class="order-code" onclick="copyCode('${o.id}')">${o.id}</code></td>
          <td>${o.product}</td>
          <td>${o.price.toLocaleString()}</td>
          <td><code>${o.seri}</code></td>
          <td style="color:${color}">${status}</td>
          <td>${o.date}</td>
        </tr>`;
      });
    }
  }

  window.buy = (name, price) => {
    if((currentUser.balance||0) < price) return alert('Không đủ tiền!');
    $('#modalInner').innerHTML = `<h3 style="color:#00ff9d">Mua ${name}</h3>
      <input id="seri" placeholder="Nhập Serial Number" style="width:100%;padding:14px;margin:12px 0;border-radius:12px;background:#000;color:#fff">
      <button class="btn" onclick="confirmBuy('${name}',${price})">Gửi đơn</button>
      <button class="btn" style="background:#666;margin-left:8px" onclick="closeModal()">Hủy</button>`;
    $('#modalRoot').style.display = 'flex';
  };

  window.confirmBuy = async (name, price) => {
    const seri = $('#seri').value.trim();
    if(!seri) return alert('Nhập SN!');
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let orderCode = '';
    for(let i=0;i<12;i++) orderCode += chars.charAt(Math.floor(Math.random()*chars.length));
    const orderId = orderCode;

    await set(ref(db,'pendingOrders/'+orderId),{orderId,email:currentUser.email,product:name,price,seri,date:new Date().toLocaleString('vi-VN')});
    await set(ref(db,'users/'+btoa(currentUser.email)+'/balance'),(currentUser.balance||0)-price);
    await push(ref(db,'users/'+btoa(currentUser.email)+'/orders'),{id:orderId,product:name,price,seri,status:'pending',date:new Date().toLocaleString('vi-VN')});

    alert(`ĐÃ GỬI ĐƠN!\nMã đơn: ${orderId}\nLưu lại để theo dõi nhé!`);
    closeModal();
  };

  $('#topupBtn').onclick = async () => {
    const amount = parseInt($('#topupAmount').value);
    if(amount<10000) return alert('Tối thiểu 10k');
    const id = 'TP'+Date.now();
    await set(ref(db,'pendingTopups/'+id),{id,email:currentUser.email,amount,date:new Date().toLocaleString('vi-VN')});
    alert('Đã gửi yêu cầu nạp! Chờ admin duyệt.');
    $('#topupAmount').value='';
  };

  $('#authBtn').onclick = () => { if(confirm('Đăng xuất?')){localStorage.removeItem('userEmail');location.href='index.html';} };
  window.closeModal = () => $('#modalRoot').style.display='none';

  loadUser();
  setInterval(()=>{if(currentUser)loadUser();},5000);
</script>
</body>
</html>
