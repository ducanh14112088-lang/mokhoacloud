<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>iBYPASS SHOP - Cửa hàng</title>
  <meta name="theme neuen-color" content="#00ff9d">
  <style>
    :root{--pri:#00ff9d;--bg:#0a0a0f;--card:#111118;--warn:#ff6b6b}
    body{margin:0;font-family:Segoe UI,sans-serif;background:var(--bg);color:#e0e7ff;min-height:100vh}
    header{position:sticky;top:0;z-index:99;background:rgba(10,10,15,0.95);backdrop-filter:blur(12px);border-bottom:1px solid #333;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:30px;font-weight:900;background:linear-gradient(90deg,#00ff9d,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .online-badge{background:#00ff9d;color:#000;padding:4px 12px;border-radius:20px;font-size:12px;animation:blink 2s infinite;font-weight:900}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(0,255,157,0.2);border-radius:18px;padding:28px;margin-bottom:24px;box-shadow:0 10px 40px #0006}
    #products{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-top:20px}
    .product{background:rgba(0,255,157,0.05);border:1px solid rgba(0,255,157,0.3);border-radius:16px;padding:24px;text-align:center;transition:.3s}
    .product:hover{transform:translateY(-8px);box-shadow:0 15px 30px rgba(0,255,157,0.2)}
    .price{font-size:32px;font-weight:900;color:#00ff9d}
    .btn{background:linear-gradient(90deg,#00ff9d,#00d4ff);color:#000;padding:14px 32px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn-buy{width:100%;padding:16px;font-size:18px}
    .warning{background:#300;border:2px solid var(--warn);padding:20px;border-radius:16px}
    #loader{position:fixed;inset:0;background:#0a0a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#00ff9d;font-size:24px}
    .spinner{width:60px;height:60px;border:6px solid #333;border-top:6px solid #00ff9d;border-radius:50%;animation:s 1s linear infinite;margin-top:20px}
    @keyframes s{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .telegram-btn{position:fixed;bottom:20px;left:20px;background:#0088cc;color:white;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px #0088cc88;z-index:999}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{max-width:500px;width:90%;background:#111;padding:30px;border-radius:18px;border:2px solid var(--pri);text-align:center}
    .backtop{position:fixed;bottom:20px;right:20px;background:#00ff9d;color:#000;padding:15px 18px;border:none;border-radius:50%;font-size:24px;box-shadow:0 4px 20px #00ff9d88;z-index:99;cursor:pointer}
    code{cursor:pointer}
  </style>
</head>
<body>

<div id="loader"><div>Đang tải iBYPASS SHOP...</div><div class="spinner"></div></div>

<header>
  <div><span class="logo">iBYPASS</span> SHOP <span class="online-badge">ONLINE</span></div>
  <nav>
    <a href="index.html">Trang chủ</a>
    <a href="dashboard.html">Cửa hàng</a>
    <a href="admin.html" id="adminLink" style="display:none;background:#300;color:#ff0066;padding:8px 16px;border-radius:12px;font-weight:700">ADMIN PANEL</a>
    <span id="status">Chưa đăng nhập</span>
    <button class="btn" id="authBtn">Đăng xuất</button>
  </nav>
</header>

<div class="container">
  <div class="card" style="text-align:center">
    <h1 style="color:#00ff9d;font-size:36px;margin:0">Số dư: <span id="balance">0</span> ₫</h1>
  </div>

  <div class="card warning">
    <h2 style="color:var(--warn)">LƯU Ý</h2>
    <ul style="color:#ffaa00;line-height:2">
      <li>Tất cả dịch vụ **KHÔNG CÓ SÓNG** – chỉ dùng WiFi</li>
      <li>Không hoàn tiền nếu lỗi source > 48h</li>
    </ul>
  </div>

  <div id="products"></div>

  <div class="card">
    <h2>Nạp tiền tự động 24/7</h2>
    <p>STK: <strong>1404123456</strong> – MB Bank – <strong>NGUYEN DUC ANH</strong></p>
    <p>Nội dung chuyển khoản: <code style="color:#00ff9d;font-size:20px" id="emailShow">...</code></p>
    <input id="topupAmount" type="number" placeholder="Nhập số tiền (VD: 200000)" style="padding:14px;width:100%;border-radius:12px;background:#000;color:#fff;border:1px solid #333;margin:10px 0">
    <button class="btn" id="topupBtn">Tôi đã chuyển tiền</button>
  </div>

  <div class="card" id="history" style="display:none">
    <h2>Lịch sử đơn hàng</h2>
    <table width="100%" style="text-align:center">
        <thead style="background:#222">
            <tr>
                <th>Mã</th>
                <th>Sản phẩm</th>
                <th>Giá</th>
                <th>Seri</th>
                <th>Trạng thái</th>
                <th>Thời gian</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<button class="backtop" onclick="scrollTo(0,0)">Up</button>

<a href="https://t.me/dung_tool_wallet" target="_blank" class="telegram-btn" title="Telegram">
  <svg viewBox="0 0 240.83 240.83" width="36" height="36" fill="#fff" xmlns="http://www.w3.org/2000/svg">
    <path d="M57.65 184.28c-12.48 0-4.03-9.05-4.03-9.05l120.35-74.03c8.06-5.02 8.06-3.35 8.06-3.35l-124.38-74.03s-16.51-8.06-16.51 8.06c0 8.06 6.04  가족36.24 12.08 67.99l18.12 60.94s1.01 12.08 12.08 12.08c12.08 0 25.16-13.09 25.16-13.09l36.24-24.16 66.98 49.86c15.1 8.06 25.16 4.03 25.16 4.03l18.12-153.92s18.12-18.12 0-25.16c-12.08-5.02-36.24 20.14-36.24 20.14l-145.51 93.19c-12.08 6.04-25.16 9.05-25.16 9.05z"/>
  </svg>
</a>

<div id="modalRoot" class="modal-backdrop"><div class="modal" id="modalInner"></div></div>

<audio id="notiSound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" preload="auto"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, set, push, onValue, runTransaction, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyAidLdO5tVK8CkwRdMY91hG-ulXiNEohl4",
    authDomain: "mokhoacloud.firebaseapp.com",
    databaseURL: "https://mokhoacloud-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mokhoacloud",
    storageBucket: "mokhoacloud.firebasestorage.app",
    messagingSenderId: "1013749304224",
    appId: "1:1013749304224:web:2a02b904c17c0aaf7c32c5"
  });
  const db = getDatabase(app);

  if (!localStorage.getItem('userEmail')) location.href = 'index.html';
  document.getElementById('loader').remove();

  const $ = s => document.querySelector(s);
  window.$ = $; // **FIXED: Đảm bảo $ có thể được gọi từ HTML onclick (cho nút Hủy)**
  const sound = $('#notiSound');
  let currentUser = null;

  const defaultProducts = {p1:{name:"Nothing PRO Bypass iPhone 11 → 17 Pro Max",price:120000,desc:"iOS 18.6–26.1 • Full thông báo • Win"},p2:{name:"HFZ Activator A12+ Premium",price:120000,desc:"All iDevice • Full Notification"},p3:{name:"iRemove Tool A12+ Instant",price:160000,desc:"Mac & Win • Instant"},p4:{name:"Mina A12–M4 No Signal",price:210000,desc:"All iPhone/iPad A12–M4"},p5:{name:"FRPFILE Hello Screen",price:90000,desc:"XR–17 Pro Max • Full iCloud"}};

  // Load user + realtime balance + history
  const userRef = ref(db, 'users/' + btoa(localStorage.getItem('userEmail')));
  onValue(userRef, s => {
    if (s.exists()) {
      currentUser = { ...s.val(), email: localStorage.getItem('userEmail') };
      const isAdmin = currentUser.email==='998822jj@gmail.com' || currentUser.email==='998822jj';

      $('#status').textContent = currentUser.email + (isAdmin?' (Admin)':'');
      $('#status').style.color = isAdmin?'#ff0066':'#00ff9d';
      $('#adminLink').style.display = isAdmin?'inline':'none';
      $('#emailShow').textContent = currentUser.email;
      $('#balance').textContent = (currentUser.balance||0).toLocaleString();
      renderHistory(); // **FIXED: Đảm bảo lịch sử được cập nhật mỗi khi user data thay đổi**
    }
  });

  // Load + tạo 5 sản phẩm cũ
  onValue(ref(db,'products'), s => {
    let p = s.val() || {};
    if (Object.keys(p).length===0) { set(ref(db,'products'), defaultProducts); p = defaultProducts; }
    $('#products').innerHTML = Object.values(p).map(x=>`
      <div class="product"><h3>${x.name}</h3><p>${x.desc}</p><div class="price">${x.price.toLocaleString()}₫</div>
      <button class="btn btn-buy" onclick="buy('${x.name.replace(/'/g,"\\'")}',${x.price})">MUA NGAY</button></div>
    `).join('');
  });

  // NẠP TIỀN
  $('#topupBtn').onclick = async () => {
    const amount = parseInt($('#topupAmount').value);
    if (!amount || amount < 10000) return alert('Tối thiểu 10.000₫');
    const id = 'NAP_'+Date.now();
    await set(ref(db, 'pendingTopups/'+id), {
      id, email: currentUser.email, amount,
      date: new Date().toLocaleString('vi-VN'),
      status: 'pending'
    });
    alert('ĐÃ GỬI YÊU CẦU NẠP!\nAdmin sẽ duyệt ngay!');
    $('#topupAmount').value = '';
  };

  window.buy = (n,p) => {
    if ((currentUser?.balance||0) < p) return alert('Không đủ tiền!');
    $('#modalInner').innerHTML = `<h3 style="color:#00ff9d">Mua: ${n}</h3>
      <input id="seri" placeholder="Serial / IMEI" style="width:100%;padding:14px;margin:12px 0;border-radius:12px;background:#000;color:#fff">
      <button class="btn" onclick="ok('${n}',${p})">GỬI ĐƠN</button>
      <button class="btn" style="background:#666;margin-left:8px" onclick="$('#modalRoot').style.display='none'">Hủy</button>`;
    $('#modalRoot').style.display='flex';
  };

  // GỬI ĐƠN HÀNG – SỬ DỤNG CÙNG MỘT orderId CHO CẢ ADMIN VÀ USER
  window.ok = async (n,p) => {
    const seri = $('#seri').value.trim();
    if (!seri) return alert('Nhập Serial!');
    
    // TẠO MỘT KEY DUY NHẤT VÀ SỬ DỤNG LÀM orderId CHO CẢ 2 NƠI
    const newOrderRef = push(ref(db, 'users/'+btoa(currentUser.email)+'/orders'));
    const orderId = newOrderRef.key; // Lấy key ngẫu nhiên Firebase tạo
    
    // 1. Ghi đơn hàng vào lịch sử của USER
    await set(newOrderRef, {id:orderId, product:n, price:p, seri, status:'pending', date:new Date().toLocaleString('vi-VN')});
    
    // 2. Ghi đơn hàng vào pendingOrders để ADMIN xử lý
    await set(ref(db,'pendingOrders/'+orderId), {orderId, email:currentUser.email, product:n, price:p, seri, date:new Date().toLocaleString('vi-VN')});
    
    // 3. Trừ tiền
    await runTransaction(ref(db, 'users/'+btoa(currentUser.email)+'/balance'), v => (v||0)-p);
    
    alert('ĐÃ GỬI ĐƠN!\nMã đơn: '+orderId);
    $('#modalRoot').style.display='none';
  };

  function renderHistory() {
    if (!currentUser?.orders) {
      $('#history').style.display = 'none';
      return;
    }
    // Lấy tất cả đơn hàng, sắp xếp theo thứ tự ngược (mới nhất lên trên)
    const orders = Object.values(currentUser.orders).reverse();
    
    if (orders.length > 0) {
      $('#history').style.display = 'block';
      $('#tbody').innerHTML = orders.map(o=>`
        <tr>
            <td><code onclick="navigator.clipboard.writeText('${o.id}');alert('Đã copy mã đơn hàng!')">${o.id}</code></td>
            <td>${o.product}</td>
            <td>${o.price.toLocaleString()}</td>
            <td><code>${o.seri||'-'}</code></td>
            <td style="color:${o.status==='success'?'#00ff9d':o.status==='refunded'?'#ff6b6b':'#ffaa00'}">
                ${o.status==='success'?'DONE':o.status==='refunded'?'HOÀN TIỀN':'PENDING'}
            </td>
            <td>${o.date}</td>
        </tr>
      `).join('');
    } else {
        $('#history').style.display = 'none';
    }
  }

  $('#authBtn').onclick = () => confirm('Đăng xuất?') && (localStorage.removeItem('userEmail'), location.href='index.html');
</script>
</body>
</html>
