<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>iBYPASS SHOP - Cửa hàng</title>
  <style>
    :root{--pri:#00ff9d;--bg:#0a0a0f;--card:#111118;--warn:#ff6b6b}
    body{margin:0;font-family:Segoe UI,sans-serif;background:var(--bg);color:#e0e7ff;min-height:100vh}
    header{position:sticky;top:0;z-index:99;background:rgba(10,10,15,0.95);backdrop-filter:blur(12px);border-bottom:1px solid #333;padding:14px 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:30px;font-weight:900;background:linear-gradient(90deg,#00ff9d,#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(0,255,157,0.2);border-radius:18px;padding:28px;margin-bottom:24px;box-shadow:0 10px 40px #0006}
    #products{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-top:20px}
    .product{background:rgba(0,255,157,0.05);border:1px solid rgba(0,255,157,0.3);border-radius:16px;padding:24px;text-align:center;transition:.3s}
    .product:hover{transform:translateY(-8px);box-shadow:0 15px 30px rgba(0,255,157,0.2)}
    .price{font-size:32px;font-weight:900;color:#00ff9d}
    .btn{background:linear-gradient(90deg,#00ff9d,#00d4ff);color:#000;padding:14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn-buy{width:100%;padding:16px;font-size:18px}
    .warning{background:#300;border:2px solid var(--warn);padding:20px;border-radius:16px}
    .status-pending{background:#ffaa0044;color:#ffaa00;padding:4px 10px;border-radius:8px}
    .status-success{background:#00ff9d44;color:#00ff9d;padding:4px 10px;border-radius:8px}
    .status-refunded{background:var(--warn)44;color:var(--warn);padding:4px 10px;border-radius:8px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:999}
    .modal{max-width:500px;width:90%;background:#111;padding:30px;border-radius:18px;border:2px solid var(--pri)}
    #adminPanel{background:#100;border:2px solid #ff0066;padding:30px;border-radius:20px;margin:20px 0;display:none}
    .admin-item{background:#200;padding:16px;margin:12px 0;border-left:4px solid #ffaa00;border-radius:8px}
    .admin-topup{background:#002;border-left:4px solid #00d4ff}
  </style>
</head>
<body>

<header>
  <div><span class="logo">iBYPASS</span> SHOP</div>
  <nav>
    <a href="index.html">Trang chủ</a>
    <a href="dashboard.html">Cửa hàng</a>
    <span id="status">Chưa đăng nhập</span>
    <button class="btn" id="authBtn">Đăng nhập</button>
  </nav>
</header>

<div class="container">
  <div class="card" style="text-align:center">
    <h1 style="color:#00ff9d;font-size:36px;margin:0">Số dư: <span id="balance">0</span> VND</h1>
  </div>

  <div class="card warning">
    <h2 style="color:var(--warn)">LƯU Ý CHUNG</h2>
    <ul style="color:#ffaa00;line-height:2">
      <li>Tất cả dịch vụ KHÔNG CÓ SÓNG – chỉ dùng WiFi</li>
      <li>Không hủy đơn, hoàn tiền nếu lỗi source > 48h</li>
      <li>Tháo SIM + WiFi mạnh trước khi bypass</li>
    </ul>
  </div>

  <div id="products"></div>

  <div class="card">
    <h2>Nạp tiền tự động 24/7</h2>
    <p>STK: <strong>1404123456</strong> – MB Bank – <strong>NGUYEN DUC ANH</strong></p>
    <p>Nội dung: <code style="color:#00ff9d" id="emailShow">Đăng nhập để xem</code></p>
    <input id="topupAmount" type="number" placeholder="Số tiền (VD: 100000)" style="padding:14px;margin:10px 0;width:100%;border-radius:12px;background:#000;color:#fff;border:1px solid #333">
    <button class="btn" id="topupBtn" disabled>Tôi đã chuyển</button>
  </div>

  <div class="card" id="history" style="display:none">
    <h2>Lịch sử đơn hàng</h2>
    <table width="100%"><thead><tr><th>Mã</th><th>Sản phẩm</th><th>Giá</th><th>Seri</th><th>Trạng thái</th><th>Thời gian</th></tr></thead><tbody id="tbody"></tbody></table>
  </div>

  <div id="adminPanel">
    <h2 style="color:#ff0066;text-align:center">ADMIN PANEL</h2>
    <div id="adminOrders"></div>
    <div id="adminTopups"></div>
  </div>
</div>

<div id="modalRoot" class="modal-backdrop"><div class="modal" id="modalInner"></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, set, get, push, remove, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAidLdO5tVK8CkwRdMY91hG-ulXiNEohl4",
    authDomain: "mokhoacloud.firebaseapp.com",
    databaseURL: "https://mokhoacloud-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mokhoacloud",
    storageBucket: "mokhoacloud.firebasestorage.app",
    messagingSenderId: "1013749304224",
    appId: "1:1013749304224:web:2a02b904c17c0aaf7c32c5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const PRODUCTS = [
    {id:1,name:"Nothing PRO Bypass iPhone 11 → 17 Pro Max",price:120000,desc:"iOS 18.6–26.1 • Full iCloud, Notification"},
    {id:2,name:"HFZ Activator A12+ Premium Bypass",price:120000,desc:"All iPhone/iPad • Full Notification"},
    {id:3,name:"iRemove Tool A12+ Instant API",price:160000,desc:"iOS 18.6–26.1 • Mac & Win • Instant"},
    {id:4,name:"Mina A12–M4 Bypass No Signal",price:210000,desc:"iOS 18.6–26.0.1 • All A12–M4"},
    {id:5,name:"FRPFILE Activator A12+ Hello Screen",price:90000,desc:"iPhone XR–17 Pro Max & iPad A12–M3"}
  ];

  let currentUser = null;
  let lastOrderCount = 0;
  let lastTopupCount = 0;

  const $ = s => document.querySelector(s);

  async function loadUser() {
    const email = localStorage.getItem('userEmail');
    if (!email) return;
    const userRef = ref(db, 'users/' + btoa(email));
    onValue(userRef, (snap) => {
      if (snap.exists()) {
        currentUser = snap.val();
        currentUser.email = email;
        renderAll();
      }
    });
  }

  function renderAll() {
    const u = currentUser;
    $('#status').textContent = u ? u.email + (u.isAdmin ? ' (Admin)' : '') : 'Chưa đăng nhập';
    $('#status').style.color = u?.isAdmin ? '#ff0066' : '#00ff9d';
    $('#authBtn').textContent = u ? 'Đăng xuất' : 'Đăng nhập';
    $('#emailShow').textContent = u ? u.email : 'Đăng nhập để xem';
    $('#topupBtn').disabled = !u;
    $('#balance').textContent = (u?.balance || 0).toLocaleString();
    $('#adminPanel').style.display = u?.isAdmin ? 'block' : 'none';

    // Sản phẩm
    $('#products').innerHTML = PRODUCTS.map(p => `
      <div class="product">
        <h3>${p.name}</h3><p>${p.desc}</p>
        <div class="price">${p.price.toLocaleString()}₫</div>
        <button class="btn btn-buy" onclick="buy(${p.id})">MUA NGAY</button>
      </div>
    `).join('');

    // Lịch sử
    const tbody = $('#tbody');
    tbody.innerHTML = '';
    if (u?.orders && Object.keys(u.orders).length) {
      $('#history').style.display = 'block';
      Object.values(u.orders).reverse().forEach(o => {
        const status = o.status === 'success' ? '<span class="status-success">DONE</span>' :
                      o.status === 'refunded' ? '<span class="status-refunded">HOÀN</span>' :
                      '<span class="status-pending">PENDING</span>';
        tbody.innerHTML += `<tr><td>${o.id}</td><td>${o.product}</td><td>${o.price.toLocaleString()}</td><td><code>${o.seri}</code></td><td>${status}</td><td>${o.date}</td></tr>`;
      });
    }
  }

  // Realtime admin notifications
  onValue(ref(db, 'pendingOrders'), (snap) => {
    const count = snap.val() ? Object.keys(snap.val()).length : 0;
    if (count > lastOrderCount && lastOrderCount > 0) {
      alert(`CÓ ${count - lastOrderCount} ĐƠN HÀNG MỚI!`);
    }
    lastOrderCount = count;
    if (currentUser?.isAdmin) renderPendingOrders(snap.val() || {});
  });

  onValue(ref(db, 'pendingTopups'), (snap) => {
    const count = snap.val() ? Object.keys(snap.val()).length : 0;
    if (count > lastTopupCount && lastTopupCount > 0) {
      alert(`CÓ ${count - lastTopupCount} YÊU CẦU NẠP MỚI!`);
    }
    lastTopupCount = count;
    if (currentUser?.isAdmin) renderPendingTopups(snap.val() || {});
  });

  function renderPendingOrders(orders) {
    let html = `<h3 style="color:#ffaa00">Đơn chờ xử lý (${Object.keys(orders).length})</h3>`;
    Object.values(orders).forEach(o => {
      html += `<div class="admin-item">
        <b>${o.email}</b> – ${o.product} – ${o.price.toLocaleString()}₫ – SN: <code>${o.seri}</code><br>${o.date}
        <button class="btn" style="background:#00ff9d;color:#000;margin:8px 4px 0 0" onclick="adminSuccess('${o.orderId}','${o.email}')">SUCCESS</button>
        <button class="btn" style="background:#ff0066" onclick="adminRefund('${o.orderId}','${o.email}',${o.price})">HOÀN TIỀN</button>
      </div>`;
    });
    $('#adminOrders').innerHTML = html;
  }

  function renderPendingTopups(topups) {
    let html = `<h3 style="color:#00d4ff">Nạp tiền chờ duyệt (${Object.keys(topups).length})</h3>`;
    Object.values(topups).forEach(t => {
      html += `<div class="admin-item admin-topup">
        <b>${t.email}</b> nạp ${t.amount.toLocaleString()}₫ – ${t.date}
        <button class="btn" style="background:#00ff9d;color:#000;margin-left:10px" onclick="approveTopup('${t.id}','${t.email}',${t.amount})">DUYỆT</button>
      </div>`;
    });
    $('#adminTopups').innerHTML = html;
  }

  window.buy = async (id) => {
    if (!currentUser) return location.href = 'index.html';
    const p = PRODUCTS.find(x => x.id === id);
    if ((currentUser.balance || 0) < p.price) return alert('Không đủ tiền! Nạp thêm nhé');

    $('#modalInner').innerHTML = `<h3 style="color:#00ff9d">Mua ${p.name}</h3>
      <input id="seri" placeholder="Nhập Serial Number" style="width:100%;padding:14px;margin:12px 0;border-radius:12px;background:#000;color:#fff">
      <button class="btn" onclick="confirmBuy(${p.id},'${p.name}',${p.price})">Gửi đơn</button>
      <button class="btn" style="background:#666;margin-left:8px" onclick="closeModal()">Hủy</button>`;
    $('#modalRoot').style.display = 'flex';
  };

  window.confirmBuy = async (id, name, price) => {
    const seri = $('#seri').value.trim();
    if (!seri) return alert('Nhập SN!');

    const orderId = 'ORD' + Date.now();
    const order = { orderId, email: currentUser.email, product: name, price, seri, date: new Date().toLocaleString('vi-VN') };

    await set(ref(db, 'pendingOrders/' + orderId), order);
    await set(ref(db, 'users/' + btoa(currentUser.email) + '/balance'), (currentUser.balance || 0) - price);
    await push(ref(db, 'users/' + btoa(currentUser.email) + '/orders'), { ...order, status: 'pending' });

    alert('Đơn đã gửi! Chờ admin xử lý.');
    closeModal();
  };

  $('#topupBtn').onclick = async () => {
    const amount = parseInt($('#topupAmount').value);
    if (amount < 10000) return alert('Tối thiểu 10k');
    const id = 'TP' + Date.now();
    await set(ref(db, 'pendingTopups/' + id), { id, email: currentUser.email, amount, date: new Date().toLocaleString('vi-VN') });
    alert('Yêu cầu nạp đã gửi!');
    $('#topupAmount').value = '';
  };

  window.adminSuccess = async (orderId, email) => {
    await remove(ref(db, 'pendingOrders/' + orderId));
    const userRef = ref(db, 'users/' + btoa(email) + '/orders');
    const snap = await get(userRef);
    const orders = snap.val() || {};
    Object.keys(orders).forEach(key => {
      if (orders[key].orderId === orderId) {
        set(ref(db, 'users/' + btoa(email) + '/orders/' + key + '/status'), 'success');
      }
    });
    alert('Đã SUCCESS!');
  };

  window.adminRefund = async (orderId, email, price) => {
    if (!confirm('Hoàn tiền?')) return;
    await remove(ref(db, 'pendingOrders/' + orderId));
    const userRef = ref(db, 'users/' + btoa(email));
    const snap = await get(userRef);
    const user = snap.val();
    await set(ref(db, 'users/' + btoa(email) + '/balance'), (user.balance || 0) + price);
    const ordersSnap = await get(ref(db, 'users/' + btoa(email) + '/orders'));
    const orders = ordersSnap.val() || {};
    Object.keys(orders).forEach(key => {
      if (orders[key].orderId === orderId) {
        set(ref(db, 'users/' + btoa(email) + '/orders/' + key + '/status'), 'refunded');
      }
    });
    alert('Đã hoàn tiền!');
  };

  window.approveTopup = async (id, email, amount) => {
    await remove(ref(db, 'pendingTopups/' + id));
    const userRef = ref(db, 'users/' + btoa(email));
    const snap = await get(userRef);
    const user = snap.val();
    await set(ref(db, 'users/' + btoa(email) + '/balance'), (user.balance || 0) + amount);
    alert('Đã duyệt nạp!');
  };

  $('#authBtn').onclick = () => { location.href = 'index.html'; };
  window.closeModal = () => $('#modalRoot').style.display = 'none';

  loadUser();
</script>
</body>
</html>
