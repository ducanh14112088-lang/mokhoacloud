<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ADMIN PANEL - iBYPASS SHOP</title>
  <style>
    body{margin:0;background:#0a0a0f;color:#e0e7ff;font-family:Segoe UI,sans-serif;padding:20px}
    .card{background:#111118;border:2px solid #00ff9d;border-radius:18px;padding:25px;margin:20px 0;box-shadow:0 0 30px #00ff9d33}
    h1{color:#00ff9d;text-align:center;font-size:40px;margin:0}
    table{width:100%;border-collapse:collapse;margin:20px 0}
    th,td{padding:14px;text-align:center;border-bottom:1px solid #333}
    th{background:#00ff9d;color:#000;font-weight:900}
    .btn{background:#00ff9d;color:#000;padding:10px 20px;border:none;border-radius:12px;cursor:pointer;font-weight:700}
    .btn-danger{background:#ff0066}
    .new{background:#300;border:3px solid #ff0066 !important;animation:blink 1s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:0.6}}
    .noti-count{position:fixed;top:20px;right:20px;background:#ff0066;color:#fff;padding:10px 20px;border-radius:50px;font-size:20px;font-weight:900;z-index:999;box-shadow:0 0 20px #ff0066}
    audio{display:none}
  </style>
</head>
<body>

<h1>ADMIN PANEL</h1>
<div id="notiCount" class="noti-count" style="display:none">0</div>

<div class="card">
  <h2>ĐƠN HÀNG CHỜ XỬ LÝ</h2>
  <table><thead><tr><th>Mã đơn</th><th>Email</th><th>Sản phẩm</th><th>Serial</th><th>Giá</th><th>Thời gian</th><th>Hoàn tất</th></tr></thead><tbody id="ordersBody"></tbody></table>
</div>

<div class="card">
  <h2>YÊU CẦU NẠP TIỀN MỚI</h2>
  <table><thead><tr><th>ID</th><th>Email</th><th>Số tiền</th><th>Thời gian</th><th>Duyệt</th></tr></thead><tbody id="topupsBody"></tbody></table>
</div>

<div class="card">
  <h2>QUẢN LÝ SẢN PHẨM</h2>
  <input id="pName" placeholder="Tên sản phẩm" style="width:30%;padding:12px;margin:5px;border-radius:12px;background:#000;color:#fff">
  <input id="pPrice" type="number" placeholder="Giá" style="width:20%;padding:12px;margin:5px;border-radius:12px;background:#000;color:#fff">
  <input id="pDesc" placeholder="Mô tả" style="width:40%;padding:12px;margin:5px;border-radius:12px;background:#000;color:#fff">
  <button class="btn" onclick="addProduct()">THÊM SẢN PHẨM</button>
  <div id="productList"></div>
</div>

<audio id="ding" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3" preload="auto"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const app = initializeApp({
    apiKey: "AIzaSyAidLdO5tVK8CkwRdMY91hG-ulXiNEohl4",
    authDomain: "mokhoacloud.firebaseapp.com",
    databaseURL: "https://mokhoacloud-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mokhoacloud"
  });
  const db = getDatabase(app);
  const ding = document.getElementById('ding');
  const notiCount = document.getElementById('notiCount');

  // Chỉ admin 998822jj mới vào được
  if (localStorage.getItem('userEmail') !== '998822jj') {
    alert('Chỉ admin mới vào được!');
    location.href = 'index.html';
  }

  // === 1. ĐƠN HÀNG CHỜ ===
  onValue(ref(db, 'pendingOrders'), snap => {
    const orders = snap.val() || {};
    const html = Object.keys(orders).map(key => {
      const o = orders[key];
      return `<tr class="new"><td>${o.orderId}</td><td>${o.email}</td><td>${o.product}</td><td>${o.seri}</td><td>${o.price.toLocaleString()}₫</td><td>${o.date}</td>
        <td><button class="btn" onclick="doneOrder('${key}','${o.email}','${o.orderId}')">HOÀN TẤT</button></td></tr>`;
    }).join('');
    document.getElementById('ordersBody').innerHTML = html || '<tr><td colspan="7">Không có đơn nào</td></tr>';
    updateNoti(Object.keys(orders).length);
  });

  // === 2. NẠP TIỀN CHỜ DUYỆT ===
  onValue(ref(db, 'pendingTopups'), snap => {
    const topups = snap.val() || {};
    const html = Object.keys(topups).map(key => {
      const t = topups[key];
      return `<tr class="new"><td>${t.id}</td><td>${t.email}</td><td>${t.amount.toLocaleString()}₫</td><td>${t.date}</td>
        <td><button class="btn" onclick="approveTopup('${key}','${t.email}',${t.amount})">DUYỆT</button></td></tr>`;
    }).join('');
    document.getElementById('topupsBody').innerHTML = html || '<tr><td colspan="5">Không có yêu cầu nào</td></tr>';
  });

  // === 3. QUẢN LÝ SẢN PHẨM ===
  onValue(ref(db, 'products'), snap => {
    const prods = snap.val() || {};
    document.getElementById('productList').innerHTML = Object.keys(prods).map(key => 
      `<div style="margin:15px 0;padding:15px;background:#111;border:1px solid #00ff9d;border-radius:12px">
        <strong>${prods[key].name}</strong> – ${prods[key].price.toLocaleString()}₫<br>${prods[key].desc}
        <button class="btn btn-danger" style="float:right" onclick="delProd('${key}')">XÓA</button>
      </div>`
    ).join('');
  });

  window.doneOrder = (key, email, orderId) => {
    if (!confirm('Hoàn tất đơn này?')) return;
    set(ref(db, 'users/'+btoa(email)+'/orders/'+orderId+'/status'), 'success');
    remove(ref(db, 'pendingOrders/'+key));
    alert('Đã hoàn tất đơn ' + orderId);
  };

  window.approveTopup = async (key, email, amount) => {
    if (!confirm(`Duyệt nạp ${amount.toLocaleString()}₫ cho ${email}?`)) return;
    const userRef = ref(db, 'users/'+btoa(email)+'/balance');
    await runTransaction(userRef, v => (v||0) + amount);
    remove(ref(db, 'pendingTopups/'+key));
    alert('Đã duyệt nạp thành công!');
  };

  window.addProduct = () => {
    const name = prompt('Tên sản phẩm:');
    const price = parseInt(prompt('Giá tiền:'));
    const desc = prompt('Mô tả:');
    if (name && price && desc) push(ref(db, 'products'), {name, price, desc});
  };

  window.delProd = key => confirm('Xóa sản phẩm này?') && remove(ref(db, 'products/'+key));

  // Thông báo + âm thanh khi có đơn mới hoặc nạp mới
  let lastCount = 0;
  function updateNoti(count) {
    if (count > lastCount) {
      ding.play();
      notiCount.textContent = count;
      notiCount.style.display = 'block';
    }
    lastCount = count;
  }
</script>
</body>
</html>
