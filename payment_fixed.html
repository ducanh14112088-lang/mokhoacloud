<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Payment - Fixed & Improved</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--glass:rgba(255,255,255,0.06);--accent:#6ee7b7}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071126 0%, #09243b 60%);color:#e6eef6;display:flex;align-items:flex-start;justify-content:center;padding:28px}
    .container{width:1100px;max-width:96%;}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .brand{font-weight:700;font-size:20px;display:flex;gap:10px;align-items:center}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(2,6,23,0.6);backdrop-filter: blur(6px);}
    .topbar{display:flex;gap:10px;align-items:center}
    button{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;cursor:pointer}
    button.primary{background:linear-gradient(90deg,#10b981,#06b6d4);color:#012; font-weight:600}
    #products{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:16px}
    .product{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:140px}
    .product h3{margin:0 0 8px 0}
    .meta{font-size:13px;color:#b8c6d6}
    .row{display:flex;gap:10px;align-items:center}
    .small{font-size:12px;color:#9fb0c8}
    #orderHistory{margin-top:20px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px}
    /* modal */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center}
    .modal{width:420px;max-width:94%;}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .muted{color:#9fb0c8;font-size:13px}
    footer{margin-top:18px;display:flex;gap:8px;justify-content:flex-end}
    .hint{font-size:13px;color:#9fb0c8}
    .admin-link{color:#a7ffd1;cursor:pointer;text-decoration:underline}
    @media (max-width:900px){#products{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){#products{grid-template-columns:repeat(1,1fr)} header{flex-direction:column;align-items:flex-start;gap:8px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#0ea5a5,#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700">PU</div>
        <div>
          <div>Payment Demo</div>
          <div class="small">Safe-ish prototype — client-side only</div>
        </div>
      </div>

      <div class="topbar">
        <div id="userStatus" class="muted">Not signed in</div>
        <button id="btnTopUp">Nạp tiền</button>
        <button id="btnLogin" class="primary">Đăng nhập / Đăng ký</button>
        <button id="btnAdmin">Admin</button>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Danh sách sản phẩm</h2>
        <div class="muted">Số dư: <span id="balance">0</span> VND</div>
      </div>

      <div id="products" aria-live="polite"></div>

      <div id="orderHistory" class="card" style="margin-top:18px;display:none">
        <h3>Lịch sử đơn hàng</h3>
        <table>
          <thead><tr><th>Mã</th><th>Sản phẩm</th><th>Giá</th><th>SERi</th><th>Thời gian</th></tr></thead>
          <tbody id="orderTableBody"></tbody>
        </table>
      </div>

    </section>

    <section class="card" style="margin-top:16px">
      <h3>Nội dung nạp (chuyển MB)</h3>
      <p class="muted">STK: 123456789 - Ngân hàng MB - Chủ TK: NGƯỜI BÁN</p>
      <p class="muted">Nội dung chuyển: <strong>TOPUP:&lt;email&gt;:&lt;số&gt;</strong></p>
      <p class="muted">Ghi chú: Sau khi chuyển, bấm "Tôi đã chuyển" và admin sẽ cấp tiền (mật khẩu admin: <code>1411</code>).</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="topupEmail" placeholder="Email đã đăng ký (vd: a@b.com)" />
        <input id="topupAmount" placeholder="Số tiền VND" />
        <button id="btnTopupConfirm" class="primary">Tôi đã chuyển</button>
      </div>
    </section>

    <!-- modal backdrop -->
    <div id="modalRoot" class="modal-backdrop" role="dialog" aria-hidden="true">
      <div class="modal card" id="modalInner"></div>
    </div>

  </div>

<script>
// ------------------- Utilities & data -------------------
const PRODUCTS = [
  {id:1,name:'Code A',price:10000,desc:'Seri mẫu A'},
  {id:2,name:'Code B',price:15000,desc:'Seri mẫu B'},
  {id:3,name:'Code C',price:25000,desc:'Seri mẫu C'}
];

function safeText(text){ // small sanitizer for text nodes
  return String(text==null?'':text);
}

function hashPassword(password){
  const enc = new TextEncoder();
  return crypto.subtle.digest('SHA-256', enc.encode(password)).then(buf=>{
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  });
}

function getUsers(){ return JSON.parse(localStorage.getItem('users')||'[]'); }
function saveUsers(users){ localStorage.setItem('users', JSON.stringify(users)); }
function getCurrentEmail(){ return localStorage.getItem('currentUser')||null; }
function setCurrentEmail(email){ if(email) localStorage.setItem('currentUser', email); else localStorage.removeItem('currentUser'); }

function getUser(){ const email = getCurrentEmail(); if(!email) return null; return getUsers().find(u=>u.email===email) || null; }

function saveUser(u){ const users = getUsers(); const i = users.findIndex(x=>x.email===u.email);
  if(i===-1) users.push(u); else users[i]=u; saveUsers(users);
}

function formatVND(n){ return Number(n).toLocaleString('vi-VN'); }

// ------------------- Rendering -------------------
const productsRoot = document.getElementById('products');
function renderProducts(){ productsRoot.innerHTML='';
  PRODUCTS.forEach(p=>{
    const box = document.createElement('div'); box.className='product';
    const title = document.createElement('h3'); title.textContent = p.name;
    const d = document.createElement('div'); d.className='meta'; d.textContent = p.desc;
    const price = document.createElement('div'); price.className='row';
    const priceText = document.createElement('div'); priceText.textContent = formatVND(p.price) + ' VND';
    const buy = document.createElement('button'); buy.textContent='Mua ngay'; buy.onclick = ()=>onBuy(p);
    price.appendChild(priceText); price.appendChild(buy);
    box.appendChild(title); box.appendChild(d); box.appendChild(price);
    productsRoot.appendChild(box);
  });
}

function renderUserUI(){ const status = document.getElementById('userStatus'); const bal = document.getElementById('balance');
  const user = getUser(); if(!user){ status.textContent='Chưa đăng nhập'; bal.textContent='0'; document.getElementById('orderHistory').style.display='none';
    return; }
  status.textContent = user.email + ' • ' + (user.isAdmin? 'admin' : 'user'); bal.textContent = formatVND(user.balance || 0);
  loadHistory();
}

function loadHistory(){ const user = getUser(); const box = document.getElementById('orderHistory'); const tbody = document.getElementById('orderTableBody');
  tbody.innerHTML = '';
  if(!user || !user.orders || user.orders.length===0){ box.style.display='none'; return; }
  user.orders.forEach(o=>{
    const tr = document.createElement('tr');
    [o.id,o.product, formatVND(o.price), o.seri, o.date].forEach(v=>{ const td = document.createElement('td'); td.textContent = safeText(v); tr.appendChild(td); });
    tbody.appendChild(tr);
  });
  box.style.display='block';
}

// ------------------- Modals -------------------
const modalRoot = document.getElementById('modalRoot');
const modalInner = document.getElementById('modalInner');
function showModal(htmlBuilder){ modalInner.innerHTML=''; htmlBuilder(modalInner); modalRoot.style.display='flex'; modalRoot.setAttribute('aria-hidden','false'); }
function closeModal(){ modalRoot.style.display='none'; modalRoot.setAttribute('aria-hidden','true'); }
modalRoot.addEventListener('click', (e)=>{ if(e.target===modalRoot) closeModal(); });

// ------------------- Auth flows -------------------
async function handleSignup(email, password){ if(!email || !password) { alert('Email và mật khẩu không được rỗng'); return; }
  const users = getUsers(); if(users.find(u=>u.email===email)){ alert('Email đã tồn tại'); return; }
  const hash = await hashPassword(password);
  const newUser = { email, passHash: hash, balance:0, orders:[], isAdmin:false };
  users.push(newUser); saveUsers(users); setCurrentEmail(email); renderUserUI(); closeModal(); alert('Đăng ký thành công và đã đăng nhập');
}

async function handleLogin(email,password){ if(!email||!password){ alert('Vui lòng nhập đầy đủ'); return; }
  const users = getUsers(); const user = users.find(u=>u.email===email);
  if(!user){ alert('Không tìm thấy user'); return; }
  const hash = await hashPassword(password);
  if(hash !== user.passHash){ alert('Mật khẩu sai'); return; }
  setCurrentEmail(email); renderUserUI(); closeModal(); alert('Đăng nhập thành công');
}

function showAuthModal(){ showModal((root)=>{
  const h = document.createElement('div');
  h.innerHTML = `
    <h3>Đăng nhập / Đăng ký</h3>
    <label>Email</label>
    <input id="m_email" />
    <label>Mật khẩu</label>
    <input id="m_pass" type="password" />
    <div style="display:flex;gap:8px;margin-top:12px"><button id="m_login" class="primary">Đăng nhập</button><button id="m_signup">Đăng ký</button><button id="m_close">Huỷ</button></div>
    <p class="muted">Mật khẩu được hash (SHA-256) trước khi lưu. Đây vẫn là prototype client-side.</p>
  `;
  root.appendChild(h);
  root.querySelector('#m_close').onclick = closeModal;
  root.querySelector('#m_signup').onclick = ()=>{ handleSignup(root.querySelector('#m_email').value.trim(), root.querySelector('#m_pass').value); };
  root.querySelector('#m_login').onclick = ()=>{ handleLogin(root.querySelector('#m_email').value.trim(), root.querySelector('#m_pass').value); };
}); }

// ------------------- Buy flow -------------------
let currentProduct = null;
function onBuy(product){ const user = getUser(); if(!user){ alert('Bạn cần đăng nhập trước'); showAuthModal(); return; }
  if(user.balance < product.price){ if(!confirm('Không đủ tiền. Mở trang nạp tiền?')) return; document.getElementById('topupEmail').value = user.email; return; }
  currentProduct = product;
  showModal(root=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <h3>Mua ${safeText(product.name)}</h3>
      <label>Nhập SERi (không chứa tag)</label>
      <input id="m_seri" />
      <div style="display:flex;gap:8px;margin-top:12px"><button id="confirmBuy" class="primary">Xác nhận mua - ${formatVND(product.price)} VND</button><button id="cancelBuy">Huỷ</button></div>
    `;
    root.appendChild(wrapper);
    root.querySelector('#cancelBuy').onclick = closeModal;
    root.querySelector('#confirmBuy').onclick = ()=>confirmBuy(root.querySelector('#m_seri').value.trim());
  });
}

function confirmBuy(seri){ if(!currentProduct) return; const user = getUser(); if(!user){ alert('Người dùng không tồn tại'); closeModal(); return; }
  if(!seri){ alert('Nhập seri'); return; }
  if(seri.length>500){ alert('SERi quá dài'); return; }
  // basic sanitization: no angle brackets
  if(/[<>]/.test(seri)){ alert('SERi không được chứa ký tự < hoặc >'); return; }
  user.balance = Number(user.balance) - Number(currentProduct.price);
  user.orders = user.orders || [];
  user.orders.unshift({ id: 'ORD' + Date.now(), product: currentProduct.name, price: currentProduct.price, seri: seri, date: new Date().toLocaleString() });
  saveUser(user); renderUserUI(); closeModal(); alert('Mua thành công!');
}

// ------------------- Top-up flow (manual + admin approve) -------------------
const pendingTopupsKey = 'pendingTopups';
function addPendingTopup(email, amount){ const list = JSON.parse(localStorage.getItem(pendingTopupsKey)||'[]'); list.push({id:'TP'+Date.now(), email, amount: Number(amount), date: new Date().toLocaleString()}); localStorage.setItem(pendingTopupsKey, JSON.stringify(list)); alert('Yêu cầu nạp đã được gửi. Yêu cầu admin duyệt.'); }

// ------------------- Admin panel -------------------
function showAdmin(){ showModal(root=>{
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `
    <h3>Admin - Quản lý nạp tiền</h3>
    <label>Mật khẩu admin</label>
    <input id="a_pass" type="password" />
    <div style="margin-top:8px"><button id="a_unlock" class="primary">Mở</button><button id="a_close">Huỷ</button></div>
    <div id="a_area" style="margin-top:12px;display:none"></div>
  `;
  root.appendChild(wrapper);
  root.querySelector('#a_close').onclick = closeModal;
  root.querySelector('#a_unlock').onclick = ()=>{
    const pass = root.querySelector('#a_pass').value.trim();
    if(pass!=='1411'){ alert('Mật khẩu admin sai'); return; }
    const area = root.querySelector('#a_area'); area.style.display='block'; area.innerHTML='';
    const pend = JSON.parse(localStorage.getItem(pendingTopupsKey)||'[]');
    if(pend.length===0) area.innerHTML='<p class="muted">Không có yêu cầu nạp.</p>';
    pend.forEach(p=>{
      const el = document.createElement('div'); el.style.borderTop='1px solid rgba(255,255,255,0.03)'; el.style.padding='8px 0';
      el.innerHTML = `<div><strong>${safeText(p.email)}</strong> • ${formatVND(p.amount)} VND • ${safeText(p.date)}</div>`;
      const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px'; btns.style.marginTop='8px';
      const ok = document.createElement('button'); ok.textContent='Duyệt (cộng tiền)';
      ok.onclick = ()=>{ creditUser(p.email, p.amount); removePending(p.id); el.remove(); };
      const rej = document.createElement('button'); rej.textContent='Từ chối'; rej.onclick = ()=>{ if(confirm('Từ chối yêu cầu?')){ removePending(p.id); el.remove(); } };
      btns.appendChild(ok); btns.appendChild(rej); el.appendChild(btns); area.appendChild(el);
    });
  };
}); }

function creditUser(email, amount){ const users = getUsers(); const u = users.find(x=>x.email===email); if(!u){ alert('Không tìm thấy user: '+email); return; }
  u.balance = Number(u.balance || 0) + Number(amount); saveUsers(users); alert('Đã cộng ' + formatVND(amount) + ' cho ' + email); renderUserUI(); }

function removePending(id){ const list = JSON.parse(localStorage.getItem(pendingTopupsKey)||'[]'); const next = list.filter(x=>x.id!==id); localStorage.setItem(pendingTopupsKey, JSON.stringify(next)); }

// ------------------- Events -------------------
document.getElementById('btnLogin').onclick = ()=> showAuthModal();
document.getElementById('btnTopUp').onclick = ()=>{ document.getElementById('topupEmail').value = getCurrentEmail() || ''; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); };

document.getElementById('btnAdmin').onclick = ()=> showAdmin();
document.getElementById('btnTopupConfirm').onclick = ()=>{
  const e = document.getElementById('topupEmail').value.trim(); const a = document.getElementById('topupAmount').value.trim();
  if(!e||!a||isNaN(Number(a))){ alert('Nhập email và số tiền hợp lệ'); return; }
  addPendingTopup(e, Number(a)); document.getElementById('topupAmount').value='';
};

// onload
renderProducts(); renderUserUI();

// helpful: if no users exist, create an admin user for local testing (email: admin@local)
(function ensureAdmin(){ const users = getUsers(); if(!users.find(u=>u.email==='admin@local')){
  hashPassword('adminpass').then(h=>{ users.push({email:'admin@local',passHash:h,balance:0,orders:[],isAdmin:true}); saveUsers(users); }); }
})();

</script>
</body>
</html>
